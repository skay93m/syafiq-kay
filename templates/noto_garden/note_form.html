{% extends "base/index.html" %}
{% load static %}

{% block content %}
<div class="container">
    <!-- Navigation -->
    <div class="navigation-card mb-4">
        <div class="card-body">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item">
                        <a href="{% url 'noto_garden:dashboard' %}">
                            <span class="jp-text japanese-text"><ruby>„Éé„Éº„Éà<rt>Note</rt></ruby>„ÅÆ<ruby>Â∫≠<rt>„Å´„Çè</rt></ruby></span>
                            <span class="d-none d-md-inline">Noto Garden</span>
                        </a>
                    </li>
                    {% if note %}
                        <li class="breadcrumb-item"><a href="{% url 'noto_garden:note_detail' note.unique_id %}">{{ note.unique_id }}</a></li>
                        <li class="breadcrumb-item active">
                            <span class="jp-text japanese-text"><ruby>Á∑®ÈõÜ<rt>„Å∏„Çì„Åó„ÇÖ„ÅÜ</rt></ruby></span>
                            <span class="d-none d-md-inline">Edit</span>
                        </li>
                    {% else %}
                        <li class="breadcrumb-item active">
                            <span class="jp-text japanese-text"><ruby>Êñ∞<rt>„ÅÇ„Åü„Çâ</rt></ruby>„Åó„ÅÑ<ruby>„Éé„Éº„Éà<rt>Note</rt></ruby></span>
                            <span class="d-none d-md-inline">Create Note</span>
                        </li>
                    {% endif %}
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Main Form -->
            <div class="form-card">
                <div class="card-body">
                    <h3 class="card-title mb-4">
                        <i class="fas fa-{% if note %}edit{% else %}plus{% endif %}"></i> 
                        <span class="jp-text japanese-text">
                            {% if note %}
                                <ruby>„Éé„Éº„Éà<rt>Note</rt></ruby>„Çí<ruby>Á∑®ÈõÜ<rt>„Å∏„Çì„Åó„ÇÖ„ÅÜ</rt></ruby>
                            {% else %}
                                <ruby>„Éé„Éº„Éà<rt>Note</rt></ruby>„Çí<ruby>‰ΩúÊàê<rt>„Åï„Åè„Åõ„ÅÑ</rt></ruby>
                            {% endif %}
                        </span>
                        <span class="text-muted">/ {{ action }} Note</span>
                    </h3>
                    <form method="post">
                        {% csrf_token %}
                        
                        <!-- Title -->
                        <div class="mb-3">
                            <label for="title" class="form-label">
                                <span class="jp-text japanese-text"><ruby>„Çø„Ç§„Éà„É´<rt>Title</rt></ruby></span>
                                <span class="text-muted">/ Title</span>
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="title" 
                                   name="title" 
                                   value="{{ note.title|default:'' }}"
                                   required>
                        </div>

                        <!-- Content -->
                        <div class="mb-3">
                            <label for="content" class="form-label">
                                <span class="jp-text japanese-text"><ruby>ÂÜÖÂÆπ<rt>„Å™„ÅÑ„Çà„ÅÜ</rt></ruby></span>
                                <span class="text-muted">/ Content</span>
                            </label>
                            <textarea class="form-control" 
                                      id="content" 
                                      name="content" 
                                      rows="20" 
                                      required>{{ note.content|default:'' }}</textarea>
                            <div class="form-text">
                                <span class="jp-text japanese-text">[[note_id]]„Çí<ruby>‰Ωø<rt>„Å§„Åã</rt></ruby>„Å£„Å¶<ruby>‰ªñ<rt>„Åª„Åã</rt></ruby>„ÅÆ<ruby>„Éé„Éº„Éà<rt>Note</rt></ruby>„Å´<ruby>„É™„É≥„ÇØ<rt>Link</rt></ruby>„ÄÇ</span>
                                <br>Use [[note_id]] to link to other notes. Links will be created automatically.
                            </div>
                        </div>

                        <!-- Tags -->
                        <div class="mb-3">
                            <label for="tags" class="form-label">
                                <span class="jp-text japanese-text"><ruby>„Çø„Ç∞<rt>Tag</rt></ruby></span>
                                <span class="text-muted">/ Tags</span>
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="tags" 
                                   name="tags" 
                                   value="{{ tag_string|default:'' }}"
                                   placeholder="tag1, tag2, tag3">
                            <div class="form-text">
                                <span class="jp-text japanese-text"><ruby>„Çø„Ç∞<rt>Tag</rt></ruby>„Çí<ruby>„Ç≥„É≥„Éû<rt>Comma</rt></ruby>„Åß<ruby>Âå∫Âàá<rt>„Åè„Åé</rt></ruby>„Çã„ÄÇ</span>
                                <br>Separate tags with commas. Tags will be created automatically if they don't exist.
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="d-flex justify-content-between">
                            <a href="{% if note %}{% url 'noto_garden:note_detail' note.unique_id %}{% else %}{% url 'noto_garden:dashboard' %}{% endif %}" 
                               class="btn btn-secondary">
                                <i class="fas fa-times"></i> 
                                <span class="jp-text japanese-text"><ruby>„Ç≠„É£„É≥„Çª„É´<rt>Cancel</rt></ruby></span>
                                <span class="d-none d-md-inline">Cancel</span>
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> 
                                <span class="jp-text japanese-text"><ruby>‰øùÂ≠ò<rt>„Åª„Åû„Çì</rt></ruby></span>
                                <span class="d-none d-md-inline">Save Note</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Help Card -->
            <div class="help-card mb-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-question-circle"></i>
                        <span class="jp-text japanese-text">Zettelkasten <ruby>„Éí„É≥„Éà<rt>Hint</rt></ruby></span>
                        <span class="text-muted">/ Tips</span>
                    </h5>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <strong>üîó <span class="jp-text japanese-text"><ruby>„Éé„Éº„Éà<rt>Note</rt></ruby>„Çí<ruby>„É™„É≥„ÇØ<rt>Link</rt></ruby></span>:</strong> 
                            Use [[note_id]] to connect ideas
                        </li>
                        <li class="mb-2">
                            <strong>üè∑Ô∏è <span class="jp-text japanese-text"><ruby>Ë≥¢<rt>„Åã„Åó„Åì</rt></ruby>„ÅÑ<ruby>„Çø„Ç∞<rt>Tag</rt></ruby></span>:</strong> 
                            Use tags to categorize and find notes
                        </li>
                        <li class="mb-2">
                            <strong>üí≠ <span class="jp-text japanese-text"><ruby>Â∞è<rt>„Å°„ÅÑ</rt></ruby>„Åï„Åè<ruby>ËÄÉ<rt>„Åã„Çì„Åå</rt></ruby>„Åà„Çã</span>:</strong> 
                            Focus on one concept per note
                        </li>
                        <li class="mb-2">
                            <strong>üå± <span class="jp-text japanese-text"><ruby>„Ç¢„Ç§„Éá„Ç¢<rt>Idea</rt></ruby>„Çí<ruby>ËÇ≤<rt>„Åù„Å†</rt></ruby>„Å¶„Çã</span>:</strong> 
                            Connect related thoughts over time
                        </li>
                    </ul>
                    <div class="text-center mt-3">
                        <a href="{% url 'noto_garden:guide' %}" class="btn btn-success btn-sm">
                            <i class="fas fa-book"></i> 
                            <span class="jp-text japanese-text"><ruby>ÂÆåÂÖ®<rt>„Åã„Çì„Åú„Çì</rt></ruby><ruby>„Ç¨„Ç§„Éâ<rt>Guide</rt></ruby></span>
                            <br><small>Read Full Guide</small>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Available Notes -->
            {% if action == 'Edit' %}
                <div class="search-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-search"></i>
                            <span class="jp-text japanese-text"><ruby>„É™„É≥„ÇØ<rt>Link</rt></ruby>„Åô„Çã<ruby>„Éé„Éº„Éà<rt>Note</rt></ruby>„Çí<ruby>Ê§úÁ¥¢<rt>„Åë„Çì„Åï„Åè</rt></ruby></span>
                            <span class="text-muted">/ Find Notes to Link</span>
                        </h5>
                        <input type="text" 
                               class="form-control mb-3" 
                               id="note-search" 
                               placeholder="Search notes...">
                        <div id="search-results"></div>
                        <p class="text-muted small">
                            <span class="jp-text japanese-text"><ruby>„Éé„Éº„Éà<rt>Note</rt></ruby>„Çí<ruby>„ÇØ„É™„ÉÉ„ÇØ<rt>Click</rt></ruby>„Åó„Å¶ID„Çí<ruby>„Ç≥„Éî„Éº<rt>Copy</rt></ruby>„ÄÇ</span>
                            <br>Click on a note to copy its ID for linking
                        </p>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
/* Card styling to match experiments app */
.navigation-card, .form-card, .help-card, .search-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
}

.navigation-card .card-body {
    padding: 1rem;
}

.form-card .card-body,
.help-card .card-body,
.search-card .card-body {
    padding: 2rem;
}

/* Breadcrumb styling */
.breadcrumb {
    background-color: transparent;
    padding: 0;
    margin: 0;
}

.breadcrumb-item + .breadcrumb-item::before {
    content: ">";
    color: #6c757d;
}

.breadcrumb-item a {
    color: #007bff;
    text-decoration: none;
}

.breadcrumb-item a:hover {
    text-decoration: underline;
}

.breadcrumb-item.active {
    color: #6c757d;
}

/* Japanese text styling */
.jp-text.japanese-text {
    font-weight: 400;
    color: inherit;
}

.jp-text.japanese-text ruby {
    ruby-align: center;
}

.jp-text.japanese-text rt {
    font-size: 0.6em;
    color: #6c757d;
}

/* Card title styling */
.card-title {
    font-weight: 600;
    color: #495057;
    margin-bottom: 1rem;
}

/* Form styling */
.form-control {
    border-radius: 6px;
    border: 1px solid #ced4da;
    padding: 0.5rem 0.75rem;
}

.form-control:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
}

.form-label {
    font-weight: 500;
    color: #495057;
    margin-bottom: 0.5rem;
}

.form-text {
    color: #6c757d;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

/* Button styling */
.btn {
    border-radius: 6px;
    padding: 0.5rem 1rem;
    font-weight: 500;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.btn small {
    display: block;
    font-size: 0.75rem;
    margin-top: 0.25rem;
}

/* Search results styling */
.search-result {
    padding: 8px;
    border-radius: 4px;
    cursor: pointer;
    margin-bottom: 4px;
    border: 1px solid #e9ecef;
}

.search-result:hover {
    background-color: #f8f9fa;
    border-color: #dee2e6;
}

.note-id {
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    font-size: 0.8rem;
    color: #6c757d;
    background-color: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .form-card .card-body,
    .help-card .card-body,
    .search-card .card-body {
        padding: 1.5rem;
    }
    
    .card-title {
        font-size: 1.25rem;
    }
    
    .btn {
        padding: 0.375rem 0.75rem;
        font-size: 0.9rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const noteSearch = document.getElementById('note-search');
    const searchResults = document.getElementById('search-results');
    
    if (noteSearch) {
        let searchTimeout;
        
        noteSearch.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query.length < 2) {
                searchResults.innerHTML = '';
                return;
            }
            
            searchTimeout = setTimeout(() => {
                fetch('{% url "noto_garden:search_notes" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({query: query})
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Search failed');
                    }
                    return response.json();
                })
                .then(data => {
                    searchResults.innerHTML = '';
                    
                    if (data.error) {
                        searchResults.innerHTML = '<p class="text-danger small">' + data.error + '</p>';
                        return;
                    }
                    
                    if (data.results.length === 0) {
                        searchResults.innerHTML = '<p class="text-muted small">No notes found</p>';
                        return;
                    }
                    
                    data.results.forEach(note => {
                        const div = document.createElement('div');
                        div.className = 'search-result';
                        div.innerHTML = `
                            <div class="fw-bold">${note.title}</div>
                            <div class="note-id">${note.id}</div>
                        `;
                        
                        div.addEventListener('click', function() {
                            navigator.clipboard.writeText(note.id).then(() => {
                                // Show copied feedback
                                const originalText = div.innerHTML;
                                div.innerHTML = '<div class="text-success">ID copied!</div>';
                                setTimeout(() => {
                                    div.innerHTML = originalText;
                                }, 1000);
                            });
                        });
                        
                        searchResults.appendChild(div);
                    });
                })
                .catch(error => {
                    console.error('Search error:', error);
                    searchResults.innerHTML = '<p class="text-danger small">Search failed</p>';
                });
            }, 300);
        });
    }
});
</script>
{% endblock %}
