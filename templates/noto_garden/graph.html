{% extends "index.html" %}
{% load static %}

{% block content %}
<div class="container a4-width">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'noto_garden:dashboard' %}">Noto Garden</a></li>
                    <li class="breadcrumb-item active">Graph View</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-project-diagram"></i> Knowledge Graph
                    </h3>
                    <div class="btn-group-sm">
                        <button class="btn btn-sm btn-outline-secondary" onclick="resetGraph()">
                            <i class="fas fa-sync"></i> Reset View
                        </button>
                        <a href="{% url 'noto_garden:dashboard' %}" class="btn btn-sm btn-primary">
                            <i class="fas fa-arrow-left"></i> Back to Garden
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="graph-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.breadcrumb {
    background-color: transparent;
    padding: 0;
}

.card {
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.card-title {
    font-weight: 600;
}

#graph-container {
    height: 70vh;
    width: 100%;
    background-color: #fafafa;
    border: 1px solid #dee2e6;
}

.node {
    stroke: #fff;
    stroke-width: 2px;
    cursor: pointer;
}

.node:hover {
    stroke: #007bff;
    stroke-width: 3px;
}

.link {
    stroke: #999;
    stroke-opacity: 0.6;
    stroke-width: 2px;
}

.node-label {
    font-family: 'Arial', sans-serif;
    font-size: 12px;
    fill: #333;
    text-anchor: middle;
    pointer-events: none;
}

.tooltip {
    position: absolute;
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 8px;
    border-radius: 4px;
    font-size: 12px;
    pointer-events: none;
    z-index: 1000;
}
</style>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
// Graph data from Django
const graphData = {{ graph_data|safe }};

// Set up dimensions
const container = document.getElementById('graph-container');
const width = container.clientWidth;
const height = container.clientHeight;

// Create SVG
const svg = d3.select('#graph-container')
    .append('svg')
    .attr('width', width)
    .attr('height', height);

// Create container for zoom
const g = svg.append('g');

// Set up zoom behavior
const zoom = d3.zoom()
    .scaleExtent([0.1, 4])
    .on('zoom', (event) => {
        g.attr('transform', event.transform);
    });

svg.call(zoom);

// Set up simulation
const simulation = d3.forceSimulation(graphData.nodes)
    .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(100))
    .force('charge', d3.forceManyBody().strength(-300))
    .force('center', d3.forceCenter(width / 2, height / 2))
    .force('collision', d3.forceCollide().radius(30));

// Create links
const link = g.append('g')
    .selectAll('line')
    .data(graphData.links)
    .enter()
    .append('line')
    .attr('class', 'link');

// Create nodes
const node = g.append('g')
    .selectAll('circle')
    .data(graphData.nodes)
    .enter()
    .append('circle')
    .attr('class', 'node')
    .attr('r', d => Math.max(8, Math.min(20, d.connections * 3 + 8)))
    .attr('fill', d => {
        if (d.connections === 0) return '#dc3545';
        if (d.connections < 3) return '#ffc107';
        if (d.connections < 6) return '#28a745';
        return '#007bff';
    })
    .call(d3.drag()
        .on('start', dragstarted)
        .on('drag', dragged)
        .on('end', dragended));

// Create labels
const label = g.append('g')
    .selectAll('text')
    .data(graphData.nodes)
    .enter()
    .append('text')
    .attr('class', 'node-label')
    .attr('dy', -25)
    .text(d => d.title.length > 20 ? d.title.substring(0, 20) + '...' : d.title);

// Create tooltip
const tooltip = d3.select('body').append('div')
    .attr('class', 'tooltip')
    .style('opacity', 0);

// Add event listeners
node.on('mouseover', (event, d) => {
    tooltip.transition()
        .duration(200)
        .style('opacity', .9);
    tooltip.html(`
        <strong>${d.title}</strong><br/>
        ID: ${d.id}<br/>
        Connections: ${d.connections}<br/>
        Words: ${d.word_count}
    `)
        .style('left', (event.pageX + 10) + 'px')
        .style('top', (event.pageY - 28) + 'px');
})
.on('mouseout', () => {
    tooltip.transition()
        .duration(500)
        .style('opacity', 0);
})
.on('click', (event, d) => {
    window.location.href = d.url;
});

// Update positions on simulation tick
simulation.on('tick', () => {
    link
        .attr('x1', d => d.source.x)
        .attr('y1', d => d.source.y)
        .attr('x2', d => d.target.x)
        .attr('y2', d => d.target.y);

    node
        .attr('cx', d => d.x)
        .attr('cy', d => d.y);

    label
        .attr('x', d => d.x)
        .attr('y', d => d.y);
});

// Drag functions
function dragstarted(event, d) {
    if (!event.active) simulation.alphaTarget(0.3).restart();
    d.fx = d.x;
    d.fy = d.y;
}

function dragged(event, d) {
    d.fx = event.x;
    d.fy = event.y;
}

function dragended(event, d) {
    if (!event.active) simulation.alphaTarget(0);
    d.fx = null;
    d.fy = null;
}

// Reset graph function
function resetGraph() {
    svg.transition()
        .duration(750)
        .call(zoom.transform, d3.zoomIdentity);
}

// Handle window resize
window.addEventListener('resize', () => {
    const newWidth = container.clientWidth;
    const newHeight = container.clientHeight;
    
    svg.attr('width', newWidth)
       .attr('height', newHeight);
    
    simulation.force('center', d3.forceCenter(newWidth / 2, newHeight / 2));
    simulation.alpha(0.3).restart();
});

// Add legend
const legend = svg.append('g')
    .attr('class', 'legend')
    .attr('transform', 'translate(20, 20)');

const legendData = [
    { color: '#dc3545', label: 'Isolated (0 connections)' },
    { color: '#ffc107', label: 'Few connections (1-2)' },
    { color: '#28a745', label: 'Well connected (3-5)' },
    { color: '#007bff', label: 'Hub (6+ connections)' }
];

const legendItem = legend.selectAll('.legend-item')
    .data(legendData)
    .enter()
    .append('g')
    .attr('class', 'legend-item')
    .attr('transform', (d, i) => `translate(0, ${i * 20})`);

legendItem.append('circle')
    .attr('r', 8)
    .attr('fill', d => d.color);

legendItem.append('text')
    .attr('x', 15)
    .attr('y', 4)
    .style('font-size', '12px')
    .style('fill', '#333')
    .text(d => d.label);
</script>
{% endblock %}
