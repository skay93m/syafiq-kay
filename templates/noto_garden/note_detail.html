{% extends "base/index.html" %}
{% load static %}
{% load furigana_extras %}

{% block content %}
<div class="container">
    <!-- Navigation -->
    <div class="navigation-card mb-4">
        <div class="card-body">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item">
                        <a href="{% url 'noto_garden:dashboard' %}">
                            <span class="jp-text japanese-text"><ruby>ノート<rt>Note</rt></ruby>の<ruby>庭<rt>にわ</rt></ruby></span>
                            <span class="d-none d-md-inline">Noto Garden</span>
                        </a>
                    </li>
                    <li class="breadcrumb-item active">{{ note.unique_id }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Note Header -->
    <div class="note-header-card mb-4">
        <div class="card-body">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start">
                <div class="mb-3 mb-md-0">
                    <h1 class="note-title mb-2">{{ note.title }}</h1>
                    <div class="note-meta">
                        <div class="meta-item">
                            <i class="fas fa-key"></i>
                            <span class="jp-text japanese-text">ID:</span>
                            <code>{{ note.unique_id }}</code>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-calendar"></i>
                            <span class="jp-text japanese-text"><ruby>作成<rt>さくせい</rt></ruby>:</span>
                            <span class="jp-text japanese-text">{{ note.created_at|date:"Y年m月d日" }}</span>
                            <span class="d-none d-md-inline">/ {{ note.created_at|date:"jS M Y" }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-edit"></i>
                            <span class="jp-text japanese-text"><ruby>更新<rt>こうしん</rt></ruby>:</span>
                            <span class="jp-text japanese-text">{{ note.updated_at|date:"Y年m月d日" }}</span>
                            <span class="d-none d-md-inline">/ {{ note.updated_at|date:"jS M Y" }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-font"></i>
                            <span class="jp-text japanese-text"><ruby>文字数<rt>もじすう</rt></ruby>:</span>
                            <span>{{ note.get_word_count }} words</span>
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                    {% if user.is_staff %}
                        <a href="{% url 'noto_garden:note_edit' note.unique_id %}" class="btn btn-primary">
                            <i class="fas fa-edit"></i> 
                            <span class="jp-text japanese-text"><ruby>編集<rt>へんしゅう</rt></ruby></span>
                            <span class="d-none d-md-inline">Edit</span>
                        </a>
                    {% endif %}
                    <a href="{% url 'noto_garden:graph' %}" class="btn btn-info">
                        <i class="fas fa-project-diagram"></i> 
                        <span class="jp-text japanese-text"><ruby>グラフ<rt>Graph</rt></ruby></span>
                        <span class="d-none d-md-inline">Graph</span>
                    </a>
                </div>
            </div>
            
            <!-- Tags -->
            {% if note.tags.exists %}
                <div class="note-tags mt-3">
                    <i class="fas fa-tags text-muted me-2"></i>
                    <span class="jp-text japanese-text"><ruby>タグ<rt>Tag</rt></ruby>:</span>
                    {% for tag in note.tags.all %}
                        <span class="badge bg-primary me-1" 
                              style="background-color: {{ tag.color }} !important;">
                            {{ tag.name }}
                        </span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <div class="col-lg-8">
            <!-- Note Content -->
            <div class="note-content-card mb-4">
                <div class="card-body">
                    <div class="note-content">
                        {{ processed_content|safe }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Connected Notes -->
            {% if connected_notes %}
                <div class="connections-card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-link"></i>
                            <span class="jp-text japanese-text"><ruby>接続<rt>せつぞく</rt></ruby><ruby>ノート<rt>Note</rt></ruby></span>
                            <span class="text-muted">/ Connected Notes</span>
                            <span class="badge bg-primary ms-2">{{ connected_notes.count }}</span>
                        </h5>
                        <div class="connections-list">
                            {% for connected_note in connected_notes %}
                                <div class="connection-item">
                                    <a href="{% url 'noto_garden:note_detail' connected_note.unique_id %}" 
                                       class="connection-link">
                                        <strong>{{ connected_note.title }}</strong>
                                    </a>
                                    <br>
                                    <small class="text-muted">ID: {{ connected_note.unique_id }}</small>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Backlinks -->
            {% if backlinks %}
                <div class="backlinks-card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-arrow-left"></i>
                            <span class="jp-text japanese-text"><ruby>逆<rt>ぎゃく</rt></ruby><ruby>リンク<rt>Link</rt></ruby></span>
                            <span class="text-muted">/ Backlinks</span>
                            <span class="badge bg-secondary ms-2">{{ backlinks.count }}</span>
                        </h5>
                        <div class="backlinks-list">
                            {% for backlink in backlinks %}
                                <div class="backlink-item">
                                    <a href="{% url 'noto_garden:note_detail' backlink.unique_id %}" 
                                       class="backlink-link">
                                        <strong>{{ backlink.title }}</strong>
                                    </a>
                                    <br>
                                    <small class="text-muted">ID: {{ backlink.unique_id }}</small>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Quick Actions -->
            <div class="actions-card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-bolt"></i>
                        <span class="jp-text japanese-text"><ruby>クイック<rt>Quick</rt></ruby><ruby>アクション<rt>Action</rt></ruby></span>
                        <span class="text-muted">/ Quick Actions</span>
                    </h5>
                    <div class="d-grid gap-2">
                        {% if user.is_staff %}
                            <a href="{% url 'noto_garden:note_create' %}" class="btn btn-outline-primary">
                                <i class="fas fa-plus"></i>
                                <span class="jp-text japanese-text"><ruby>新<rt>あたら</rt></ruby>しい<ruby>ノート<rt>Note</rt></ruby></span>
                                <br><small>Create New Note</small>
                            </a>
                        {% endif %}
                        <a href="{% url 'noto_garden:guide' %}" class="btn btn-outline-success">
                            <i class="fas fa-book"></i>
                            <span class="jp-text japanese-text"><ruby>ガイド<rt>Guide</rt></ruby></span>
                            <br><small>User Guide</small>
                        </a>
                        <a href="{% url 'noto_garden:dashboard' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i>
                            <span class="jp-text japanese-text"><ruby>庭<rt>にわ</rt></ruby>に<ruby>戻<rt>もど</rt></ruby>る</span>
                            <br><small>Back to Garden</small>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Card styling to match experiments app */
.navigation-card, .note-header-card, .note-content-card, .connections-card, .backlinks-card, .actions-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
}

.navigation-card .card-body {
    padding: 1rem;
}

.note-header-card .card-body,
.note-content-card .card-body {
    padding: 2rem;
}

.connections-card .card-body,
.backlinks-card .card-body,
.actions-card .card-body {
    padding: 1.5rem;
}

/* Note header styling */
.note-title {
    color: #495057;
    font-weight: 600;
    margin-bottom: 1rem;
    font-size: 2rem;
}

.note-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #6c757d;
    font-size: 0.9rem;
}

.meta-item i {
    width: 16px;
    text-align: center;
}

.meta-item code {
    background-color: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.8rem;
}

/* Japanese text styling */
.jp-text.japanese-text {
    font-weight: 400;
    color: inherit;
}

.jp-text.japanese-text ruby {
    ruby-align: center;
}

.jp-text.japanese-text rt {
    font-size: 0.6em;
    color: #6c757d;
}

/* Tags styling */
.note-tags .badge {
    font-size: 0.8rem;
    padding: 0.35rem 0.65rem;
    border-radius: 4px;
}

/* Content styling */
.note-content {
    font-size: 1.1rem;
    line-height: 1.8;
    color: #495057;
}

.note-content h1,
.note-content h2,
.note-content h3,
.note-content h4,
.note-content h5,
.note-content h6 {
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #495057;
}

.note-content h1 {
    font-size: 1.8rem;
    border-bottom: 2px solid #dee2e6;
    padding-bottom: 0.3rem;
}

.note-content h2 {
    font-size: 1.5rem;
    border-bottom: 1px solid #e9ecef;
    padding-bottom: 0.3rem;
}

.note-content h3 {
    font-size: 1.3rem;
}

.note-content ul,
.note-content ol {
    padding-left: 1.5rem;
    margin-bottom: 1rem;
}

.note-content li {
    margin-bottom: 0.3rem;
}

.note-content blockquote {
    border-left: 4px solid #007bff;
    margin: 1rem 0;
    padding: 0.5rem 1rem;
    background-color: #f8f9fa;
    font-style: italic;
}

.note-content code {
    background-color: #f8f9fa;
    border-radius: 3px;
    font-size: 0.9rem;
    margin: 0;
    padding: 0.2rem 0.4rem;
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    color: #e83e8c;
}

.note-content pre {
    background-color: #f8f9fa;
    border-radius: 6px;
    font-size: 0.9rem;
    line-height: 1.45;
    overflow: auto;
    padding: 1rem;
    margin: 1rem 0;
    border-left: 4px solid #007bff;
}

.note-content pre code {
    background-color: transparent;
    border: 0;
    display: inline;
    line-height: inherit;
    margin: 0;
    max-width: auto;
    overflow: visible;
    padding: 0;
    word-wrap: normal;
    color: #495057;
}

.note-content table {
    border-collapse: collapse;
    border-spacing: 0;
    width: 100%;
    margin: 1rem 0;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.note-content table th,
.note-content table td {
    border: 1px solid #dee2e6;
    padding: 0.75rem;
    text-align: left;
}

.note-content table th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #495057;
}

.note-content table tbody tr:hover {
    background-color: #f8f9fa;
}

.note-content hr {
    background-color: #dee2e6;
    border: 0;
    height: 2px;
    margin: 1.5rem 0;
}

.note-content strong {
    font-weight: 600;
}

.note-content p {
    margin-bottom: 1rem;
}

/* Note links styling */
.note-link {
    color: #007bff;
    text-decoration: none;
    font-weight: 600;
    padding: 2px 6px;
    background-color: #e3f2fd;
    border-radius: 4px;
}

.note-link:hover {
    background-color: #bbdefb;
    text-decoration: none;
}

.missing-link {
    color: #dc3545;
    font-style: italic;
    padding: 2px 6px;
    background-color: #ffebee;
    border-radius: 4px;
}

/* Sidebar styling */
.connections-list, .backlinks-list {
    max-height: 300px;
    overflow-y: auto;
}

.connection-item, .backlink-item {
    padding: 0.75rem 0;
    border-bottom: 1px solid #e9ecef;
}

.connection-item:last-child, .backlink-item:last-child {
    border-bottom: none;
}

.connection-link, .backlink-link {
    color: #007bff;
    text-decoration: none;
    font-weight: 600;
}

.connection-link:hover, .backlink-link:hover {
    text-decoration: underline;
}

/* Breadcrumb styling */
.breadcrumb {
    background-color: transparent;
    padding: 0;
    margin: 0;
}

.breadcrumb-item + .breadcrumb-item::before {
    content: ">";
    color: #6c757d;
}

.breadcrumb-item a {
    color: #007bff;
    text-decoration: none;
}

.breadcrumb-item a:hover {
    text-decoration: underline;
}

.breadcrumb-item.active {
    color: #6c757d;
}

/* Badge styling */
.badge {
    font-size: 0.8rem;
    padding: 0.35rem 0.65rem;
    border-radius: 4px;
}

/* Card title styling */
.card-title {
    margin-bottom: 1rem;
    font-weight: 600;
    color: #495057;
}

/* Button styling */
.btn {
    border-radius: 6px;
}

.btn small {
    display: block;
    font-size: 0.75rem;
    margin-top: 0.25rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .note-header-card .card-body,
    .note-content-card .card-body {
        padding: 1.5rem;
    }
    
    .note-title {
        font-size: 1.5rem;
    }
    
    .note-meta {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .note-content {
        font-size: 1rem;
    }
    
    .note-content pre {
        font-size: 0.8rem;
    }
}

/* Ensure code blocks don't overflow */
.note-content code {
    word-break: break-all;
    white-space: pre-wrap;
}

.note-content pre {
    overflow-x: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
}
</style>
{% endblock %}
