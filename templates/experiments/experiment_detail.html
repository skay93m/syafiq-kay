{% extends 'base/index.html' %}
{% load static %}
{% load furigana_extras %}

{% block title %}{{ experiment.title }} - Experiments Laboratory{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'experiments:dashboard' %}">🧪 Experiments</a></li>
            <li class="breadcrumb-item"><a href="{% url 'experiments:dashboard' %}" class="jp-text japanese-text">🧪 <ruby>実験<rt>じっけん</rt></ruby></a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ experiment.title }}</li>
        </ol>
    </nav>

    <!-- Header Section -->
    <div class="row mb-5">
        <div class="col-md-8">
            <h1 class="display-5 mb-3">{{ experiment.title }}</h1>
            <p class="lead text-muted">{{ experiment.description }}</p>
        </div>
        <div class="col-md-4 text-end">
            <!-- Status Badge -->
            <div class="mb-3">
                {% if experiment.status == 'conceptualizing' %}
                <span class="badge bg-secondary fs-5">💭 Conceptualizing</span>
                <div class="jp-text japanese-text"><small><ruby>構想<rt>こうそう</rt></ruby><ruby>中<rt>ちゅう</rt></ruby></small></div>
                {% elif experiment.status == 'designing' %}
                <span class="badge bg-primary fs-5">📐 Designing</span>
                <div class="jp-text japanese-text"><small><ruby>設計<rt>せっけい</rt></ruby><ruby>中<rt>ちゅう</rt></ruby></small></div>
                {% elif experiment.status == 'testing' %}
                <span class="badge bg-warning fs-5">🧪 Testing</span>
                <div class="jp-text japanese-text"><small><ruby>実験<rt>じっけん</rt></ruby><ruby>中<rt>ちゅう</rt></ruby></small></div>
                {% elif experiment.status == 'analyzing' %}
                <span class="badge bg-info fs-5">📊 Analyzing</span>
                <div class="jp-text japanese-text"><small><ruby>分析<rt>ぶんせき</rt></ruby><ruby>中<rt>ちゅう</rt></ruby></small></div>
                {% elif experiment.status == 'completed' %}
                <span class="badge bg-success fs-5">✅ Completed</span>
                <div class="jp-text japanese-text"><small><ruby>完了<rt>かんりょう</rt></ruby></small></div>
                {% elif experiment.status == 'abandoned' %}
                <span class="badge bg-danger fs-5">❌ Abandoned</span>
                <div class="jp-text japanese-text"><small><ruby>中止<rt>ちゅうし</rt></ruby></small></div>
                {% endif %}
            </div>
            
            <!-- Meta Information -->
            <div class="text-muted">
                <small>
                    📅 Created: {{ experiment.created_at|date:"M d, Y" }}<br>
                    {% if experiment.updated_at != experiment.created_at %}
                    🔄 Updated: {{ experiment.updated_at|date:"M d, Y" }}<br>
                    {% endif %}
                    📚 {{ experiment.resources.count }} resource{{ experiment.resources.count|pluralize }}
                </small>
            </div>
            <div class="text-muted jp-text japanese-text">
                <small>
                    📅 <ruby>作成<rt>さくせい</rt></ruby>: {{ experiment.created_at|date:"Y年m月d日" }}<br>
                    {% if experiment.updated_at != experiment.created_at %}
                    🔄 <ruby>更新<rt>こうしん</rt></ruby>: {{ experiment.updated_at|date:"Y年m月d日" }}<br>
                    {% endif %}
                    📚 {{ experiment.resources.count }}個の<ruby>資料<rt>しりょう</rt></ruby>
                </small>
            </div>
        </div>
    </div>

    <!-- Tags -->
    {% if experiment.tags %}
    <div class="mb-4">
        <h6>🏷️ Tags:</h6>
        <h6 class="jp-text japanese-text">🏷️ <ruby>タグ<rt>Tag</rt></ruby>:</h6>
        {% for tag in experiment.get_tag_list %}
        <span class="badge bg-secondary me-1">{{ tag }}</span>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Experiment Content -->
    <div class="row">
        <div class="col-lg-8">
            <!-- Hypothesis -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">🎯 Hypothesis</h4>
                    <h5 class="card-subtitle mb-0 jp-text japanese-text">🎯 <ruby>仮説<rt>かせつ</rt></ruby></h5>
                </div>
                <div class="card-body">
                    <p class="card-text">{{ experiment.hypothesis|linebreaks }}</p>
                </div>
            </div>

            <!-- Methodology -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h4 class="card-title mb-0">🔬 Methodology</h4>
                    <h5 class="card-subtitle mb-0 jp-text japanese-text">🔬 <ruby>方法論<rt>ほうほうろん</rt></ruby></h5>
                </div>
                <div class="card-body">
                    <p class="card-text">{{ experiment.methodology|linebreaks }}</p>
                </div>
            </div>

            <!-- Results (if available) -->
            {% if experiment.results %}
            <div class="card mb-4">
                <div class="card-header bg-warning text-white">
                    <h4 class="card-title mb-0">📊 Results</h4>
                    <h5 class="card-subtitle mb-0 jp-text japanese-text">📊 <ruby>結果<rt>けっか</rt></ruby></h5>
                </div>
                <div class="card-body">
                    <p class="card-text">{{ experiment.results|linebreaks }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Conclusions (if available) -->
            {% if experiment.conclusions %}
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h4 class="card-title mb-0">💡 Conclusions</h4>
                    <h5 class="card-subtitle mb-0 jp-text japanese-text">💡 <ruby>結論<rt>けつろん</rt></ruby></h5>
                </div>
                <div class="card-body">
                    <p class="card-text">{{ experiment.conclusions|linebreaks }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Resources -->
            {% if experiment.resources.exists %}
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h4 class="card-title mb-0">📚 Resources</h4>
                    <h5 class="card-subtitle mb-0 jp-text japanese-text">📚 <ruby>資料<rt>しりょう</rt></ruby></h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for resource in experiment.resources.all %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">
                                    <a href="{{ resource.url }}" target="_blank" class="text-decoration-none">
                                        🔗 {{ resource.title }}
                                    </a>
                                </h6>
                                <small class="text-muted">{{ resource.created_at|date:"M d, Y" }}</small>
                                <small class="text-muted jp-text japanese-text">{{ resource.created_at|date:"Y年m月d日" }}</small>
                            </div>
                            {% if resource.description %}
                            <p class="mb-1 text-muted">{{ resource.description }}</p>
                            {% endif %}
                            <small class="text-muted">{{ resource.url }}</small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Progress Status -->
            {% if experiment.status != 'completed' and experiment.status != 'abandoned' %}
            <div class="alert alert-info">
                <h5 class="alert-heading">🚧 Experiment in Progress</h5>
                <p class="mb-0">
                    This experiment is currently in the <strong>{{ experiment.get_status_display }}</strong> phase. 
                    Check back later for updates on results and conclusions.
                </p>
                <div class="jp-text japanese-text mt-2">
                    <h6 class="alert-heading">🚧 <ruby>実験<rt>じっけん</rt></ruby><ruby>進行<rt>しんこう</rt></ruby><ruby>中<rt>ちゅう</rt></ruby></h6>
                    <p class="mb-0">
                        この<ruby>実験<rt>じっけん</rt></ruby>は<ruby>現在<rt>げんざい</rt></ruby><strong>{{ experiment.get_status_display }}</strong><ruby>段階<rt>だんかい</rt></ruby>にあります。
                        <ruby>結果<rt>けっか</rt></ruby>と<ruby>結論<rt>けつろん</rt></ruby>の<ruby>更新<rt>こうしん</rt></ruby>については<ruby>後<rt>あと</rt></ruby>でご<ruby>確認<rt>かくにん</rt></ruby>ください。
                    </p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Experiment Progress -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">📈 Progress</h5>
                    <h6 class="card-subtitle mb-0 jp-text japanese-text">📈 <ruby>進捗<rt>しんちょく</rt></ruby></h6>
                </div>
                <div class="card-body">
                    <div class="progress-steps">
                        <div class="step {% if experiment.status == 'conceptualizing' %}active{% else %}completed{% endif %}">
                            <div class="step-icon">💭</div>
                            <div class="step-label">Conceptualizing</div>
                            <div class="step-label-jp jp-text japanese-text"><ruby>構想<rt>こうそう</rt></ruby></div>
                        </div>
                        <div class="step {% if experiment.status == 'designing' %}active{% elif experiment.status == 'testing' or experiment.status == 'analyzing' or experiment.status == 'completed' %}completed{% endif %}">
                            <div class="step-icon">📐</div>
                            <div class="step-label">Designing</div>
                            <div class="step-label-jp jp-text japanese-text"><ruby>設計<rt>せっけい</rt></ruby></div>
                        </div>
                        <div class="step {% if experiment.status == 'testing' %}active{% elif experiment.status == 'analyzing' or experiment.status == 'completed' %}completed{% endif %}">
                            <div class="step-icon">🧪</div>
                            <div class="step-label">Testing</div>
                            <div class="step-label-jp jp-text japanese-text"><ruby>実験<rt>じっけん</rt></ruby></div>
                        </div>
                        <div class="step {% if experiment.status == 'analyzing' %}active{% elif experiment.status == 'completed' %}completed{% endif %}">
                            <div class="step-icon">📊</div>
                            <div class="step-label">Analyzing</div>
                            <div class="step-label-jp jp-text japanese-text"><ruby>分析<rt>ぶんせき</rt></ruby></div>
                        </div>
                        <div class="step {% if experiment.status == 'completed' %}active{% endif %}">
                            <div class="step-icon">✅</div>
                            <div class="step-label">Completed</div>
                            <div class="step-label-jp jp-text japanese-text"><ruby>完了<rt>かんりょう</rt></ruby></div>
                        </div>
                        {% if experiment.status == 'abandoned' %}
                        <div class="step active">
                            <div class="step-icon">❌</div>
                            <div class="step-label">Abandoned</div>
                            <div class="step-label-jp jp-text japanese-text"><ruby>中止<rt>ちゅうし</rt></ruby></div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">🔧 Actions</h5>
                    <h6 class="card-subtitle mb-0 jp-text japanese-text">🔧 <ruby>アクション<rt>Action</rt></ruby></h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'experiments:dashboard' %}" class="btn btn-outline-primary">
                            ← Back to Dashboard
                        </a>
                        <a href="{% url 'experiments:dashboard' %}" class="btn btn-outline-primary btn-sm jp-text japanese-text">
                            ← <ruby>ダッシュボード<rt>Dashboard</rt></ruby>に<ruby>戻<rt>もど</rt></ruby>る
                        </a>
                        <a href="/admin/experiments/experiment/{{ experiment.id }}/change/" class="btn btn-outline-secondary">
                            ⚙️ Edit Experiment
                        </a>
                        <a href="/admin/experiments/experiment/{{ experiment.id }}/change/" class="btn btn-outline-secondary btn-sm jp-text japanese-text">
                            ⚙️ <ruby>実験<rt>じっけん</rt></ruby>を<ruby>編集<rt>へんしゅう</rt></ruby>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Removed a4-width constraint for full-width layout */

.progress-steps {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.step {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    border-radius: 6px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
}

.step.active {
    background-color: #e3f2fd;
    border-color: #2196f3;
}

.step.completed {
    background-color: #e8f5e8;
    border-color: #4caf50;
}

.step-icon {
    margin-right: 8px;
    font-size: 1.2em;
}

.step-label {
    font-weight: 500;
}

.step-label-jp {
    font-size: 0.8em;
    color: #666;
    margin-top: 2px;
}

.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.card-header {
    border-bottom: 1px solid #dee2e6;
}

.jp-text {
    font-size: 0.9em;
    color: #666;
}
</style>
{% endblock %}
